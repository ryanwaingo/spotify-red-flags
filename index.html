<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Spotify Dating Red Flags</title>
  <style>
    :root{
      --bg: #F6F7FB;
      --ink: #111;
      --muted: #444;
      --pink: #FF6FB3;
      --yellow: #FFE600;
      --green: #00C853;
      --pin2: #FF3D8D;

      --b: 3px solid var(--ink);
      --pad: 22px;

      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: var(--sans);
      background: var(--bg);
      color: var(--ink);
    }

    .wrap{
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding: 26px 16px;
    }

    .frame{
      width:min(720px, 100%);
      border: var(--b);
      background:#fff;
      padding: var(--pad);
      box-shadow: 10px 10px 0 #000;
      position:relative;
    }

    .stamp{
      position:absolute;
      top: -12px;
      left: 18px;
      background: var(--yellow);
      border: var(--b);
      padding: 6px 10px;
      font-family: var(--mono);
      font-weight: 900;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      transform: rotate(-2deg);
      user-select:none;
    }

    .header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }

    .title{
      margin:0;
      font-size: 26px;
      line-height: 1.05;
      letter-spacing: -0.02em;
    }

    .subtitle{
      margin-top: 6px;
      font-family: var(--mono);
      font-size: 12px;
      opacity: 0.85;
      letter-spacing: 0.02em;
    }

    .bar{
      height: 8px;
      border: var(--b);
      background: linear-gradient(90deg, var(--pink), var(--yellow), var(--green));
      margin: 16px 0;
    }

    button, .btn{
      border: var(--b);
      background: #fff;
      color: var(--ink);
      padding: 12px 14px;
      font-weight: 900;
      cursor:pointer;
      font-family: var(--mono);
      letter-spacing: 0.06em;
      text-transform: uppercase;
      transition: transform .05s ease;
      user-select:none;
    }
    button:active, .btn:active{
      transform: translate(1px, 1px);
    }
    .primary{ background: var(--pink); }
    .secondary{ background: var(--yellow); }
    .hidden{ display:none !important; }

    .note{
      border: var(--b);
      background: #fff;
      padding: 12px;
      margin-top: 14px;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
    }

    .toast{
      margin-top: 10px;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
    }

    .openerPanel{
      border: var(--b);
      background: #fff;
      padding: 14px;
      margin-top: 14px;
    }
    .opener{
      font-size: 36px;
      font-weight: 900;
      line-height: 1.05;
      letter-spacing: -0.03em;
    }

    .rule{
      margin: 18px 0 12px 0;
      border: none;
      border-top: var(--b);
    }

    .list{
      list-style:none;
      padding:0;
      margin:0;
      display:grid;
      gap: 10px;
    }
    .list li{
      border: var(--b);
      padding: 12px 14px;
      font-weight: 900;
      font-size: 18px;
      line-height: 1.15;
      letter-spacing: -0.01em;
      position:relative;
      background: #fff;
    }

    .list li.role-core{ background: var(--yellow); }
    .list li.role-core.alt{ background: var(--green); }
    .list li.role-close{ background: var(--pink); }

    .flag{
      margin-right: 10px;
    }

    .because{
      margin-top: 8px;
      border-top: var(--b);
      padding-top: 8px;
      font-family: var(--mono);
      font-size: 12px;
      font-weight: 900;
      text-transform: none;
      letter-spacing: 0.02em;
      opacity: 0.85;
    }

    .insight{
      margin-top: 14px;
      border: var(--b);
      background: #fff;
      padding: 12px 14px;
    }
    .insight .label{
      font-family: var(--mono);
      font-weight: 900;
      font-size: 12px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      opacity: 0.8;
    }
    .insight .line{
      margin-top: 8px;
      font-weight: 900;
      font-size: 18px;
      letter-spacing: -0.01em;
    }

    .fadeIn{
      animation: pop .22s ease both;
    }
    @keyframes pop{
      from{ transform: translateY(6px); opacity:0; }
      to{ transform: translateY(0); opacity:1; }
    }

    .actions{
      margin-top: 16px;
      border: var(--b);
      background: #fff;
      padding: 12px;
      display:grid;
      gap: 10px;
      transform: translateX(-1px);
    }

    .toneRow{
      border: var(--b);
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background: var(--green);
    }
    .toneRow .label{
      font-family: var(--mono);
      font-weight: 900;
      font-size: 12px;
      letter-spacing: 0.10em;
      text-transform: uppercase;
      color: var(--ink);
      white-space:nowrap;
    }
    select{
      font-family: var(--mono);
      font-weight: 900;
      border: var(--b);
      background: #fff;
      color: var(--ink);
      padding: 8px 10px;
      cursor:pointer;
    }

    .micro{
      margin-top: 12px;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--ink);
      display:flex;
      justify-content:space-between;
      gap: 10px;
      border-top: var(--b);
      padding-top: 12px;
      align-items:flex-start;
    }
    .micro .right{
      font-weight: 900;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 11px;
      background: var(--pink);
      border: var(--b);
      padding: 6px 8px;
      transform: rotate(-1deg);
      user-select:none;
    }

    .shareCard{
      border: var(--b);
      background:#fff;
      padding: 14px;
      margin-top: 14px;
    }
    .shareMeta{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      border-bottom: var(--b);
      padding-bottom: 10px;
      margin-bottom: 12px;
      align-items:flex-start;
    }
    .shareBrand{
      font-family: var(--mono);
      font-weight: 900;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-size: 12px;
    }
    .shareHint{
      font-family: var(--mono);
      font-size: 12px;
      opacity: 0.75;
      text-align:right;
      max-width: 240px;
    }
    .shareFooter{
      margin-top: 12px;
      border-top: var(--b);
      padding-top: 10px;
      font-family: var(--mono);
      font-size: 12px;
      opacity: 0.85;
      display:flex;
      justify-content:flex-end;
    }

    .shareKit{
      border: var(--b);
      background:#fff;
      padding: 12px;
      display:grid;
      gap: 10px;
    }
    .shareRow{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }
    .shareNote{
      font-family: var(--mono);
      font-size: 12px;
      opacity: 0.8;
    }
    .shareRow a.secondary{
      text-align:center;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      text-decoration:none;
    }
    @media (max-width:520px){
      .shareRow{ grid-template-columns: 1fr; }
      .shareHint{ text-align:left; max-width:none; }
      .shareMeta{ flex-direction:column; }
      .shareFooter{ justify-content:flex-start; }
    }

    @media (max-width:420px){
      .frame{ padding:18px; }
      .opener{ font-size: 32px; }
      .list li{ font-size: 17px; }
    }
  </style>
</head>

<body>
  <main class="wrap">
    <section class="frame">
      <div class="stamp" id="stampText">WELCOME</div>

      <!-- LOGIN VIEW -->
      <div id="loginView">
        <header class="header">
          <div>
            <h1 class="title">Spotify Dating Red Flags ðŸš©</h1>
            <div class="subtitle">Log in, get roasted, screenshot, repeat.</div>
          </div>
          <button id="btnLogout" class="secondary hidden" type="button">Log out</button>
        </header>

        <div class="bar" aria-hidden="true"></div>

        <button id="btnLogin" class="primary" type="button">Continue with Spotify</button>

        <div class="note">
          We only read your listening data. We donâ€™t post. We donâ€™t save your password.
        </div>

        <div id="toast" class="toast" role="status" aria-live="polite"></div>
      </div>

      <!-- RESULTS VIEW -->
      <div id="resultsView" class="hidden" aria-label="Results">
        <header class="header">
          <div>
            <h1 class="title">Your Spotify Dating Red Flags ðŸš©</h1>
            <div class="subtitle" id="resultsSubtitle">Based on your listening habits. Not serious. Very specific.</div>
          </div>
          <button id="btnLogout2" class="secondary" type="button">Log out</button>
        </header>

        <div class="bar" aria-hidden="true"></div>

        <div id="shareCard" class="shareCard" aria-label="Share card">
          <div class="shareMeta">
            <div class="shareBrand">Spotify Dating Red Flags ðŸš©</div>
            <div class="shareHint" id="shareHint">Generated from your listening history</div>
          </div>

          <div id="openerPanel" class="openerPanel">
            <div id="openerText" class="opener"><span class="flag">ðŸš©</span>Loadingâ€¦</div>
          </div>

          <hr id="rule" class="rule" />

          <ul id="flagsList" class="list" aria-label="Red flags"></ul>

          <div id="insightBox" class="insight" role="note" aria-label="Biggest dating pattern">
            <div class="label">Biggest Dating Pattern This Year</div>
            <div id="insightLine" class="line">Loadingâ€¦</div>
          </div>
          <div class="shareFooter"><span id="shareUrl"></span></div>
        </div>

        <div class="actions">
          <button id="btnRoastAgain" class="primary" type="button">Roast Again</button>

          <div class="shareKit" aria-label="Share kit">
            <div class="shareRow">
              <a id="btnShareX" class="secondary" href="#" target="_blank" rel="noopener">Share to X</a>
              <button id="btnShareIG" class="secondary" type="button">Instagram</button>
              <button id="btnShareTT" class="secondary" type="button">TikTok</button>
            </div>
            <div class="shareRow">
              <button id="btnCopyCaption" class="primary" type="button">Copy Caption</button>
              <button id="btnSaveImage" class="secondary" type="button">Save Share Image</button>
              <button id="btnCopyLink" class="secondary" type="button">Copy Link</button>
            </div>
            <div class="shareNote" id="shareNote">Tip: post yours and tag 3 friends to compare.</div>
          </div>

          <div class="toneRow" aria-label="Tone selector">
            <div class="label">Tone</div>
            <select id="toneSelect">
              <option value="playful" selected>Playful</option>
              <option value="sharp">Sharp</option>
            </select>
          </div>

          <div id="toast2" class="toast" role="status" aria-live="polite"></div>
        </div>

        <div class="micro">
          <div class="left">If youâ€™re mad, take it up with your playlists.</div>
          <div class="right">ðŸš© VERIFIED</div>
        </div>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    /***********************
     * 0) YOU MUST SET THIS
     ***********************/
    const SPOTIFY_CLIENT_ID = "ad08cfcd496348e299ba9a840227954d";
    const REDIRECT_URI = window.location.origin + window.location.pathname; // GitHub Pages URL
    const SCOPES = [
      "user-top-read",
      "user-read-recently-played"
    ];

    /******************************************************************
     * 1) YOUR JOKES CSV (already formatted for the parser)
     ******************************************************************/
    const JOKES_CSV = `parameter,bucket,tone,priority,joke_text,notes
obscurity,mainstream,playful,2,"Says â€˜I just like good musicâ€™ and lets Spotify handle the rest.",""
obscurity,mainstream,playful,2,"Claims they donâ€™t follow trends. Quietly follows all of them.",""
obscurity,mainstream,playful,3,"Comfortable taste. Low emotional risk.",""
obscurity,mainstream,playful,3,"Prefers familiarity over surprise.",""
obscurity,mainstream,playful,3,"Trusts charts more than instincts.",""
obscurity,mainstream,playful,3,"Lets popularity do the filtering.",""
obscurity,mainstream,playful,3,"Avoids musical friction.",""
obscurity,mainstream,playful,3,"Believes good taste should be easy.",""
obscurity,taste_curious,playful,2,"Likes popular music but wants credit for finding it early.",""
obscurity,taste_curious,playful,2,"Balances discovery with vibes. Hates being called predictable.",""
obscurity,taste_curious,playful,3,"Dabbles in niche. Retreats to hits.",""
obscurity,taste_curious,playful,3,"Explores just enough to feel interesting.",""
obscurity,taste_curious,playful,3,"Samples the underground. Lives upstairs.",""
obscurity,taste_curious,playful,3,"Wants novelty with a safety net.",""
obscurity,taste_curious,playful,3,"Curates discovery carefully.",""
obscurity,obscure,playful,1,"Listens to artists with 14 followers and still calls it â€˜vibesâ€™.",""
obscurity,obscure,playful,2,"Treats obscurity like a personality trait.",""
obscurity,obscure,playful,2,"Has beef with anything that charts.",""
obscurity,obscure,playful,3,"Makes â€˜deep cutsâ€™ their whole brand.",""
obscurity,obscure,playful,3,"Finds songs like theyâ€™re secret messages.",""
obscurity,obscure,playful,3,"Thinks mainstream is a red flag.",""
repetition,craves_variety,playful,2,"Swears they love variety. Still plays the same song 6 times in a day.",""
repetition,craves_variety,playful,3,"Flirts with new songs then goes back to the ex.",""
repetition,craves_variety,playful,3,"Canâ€™t commit to a sound for more than 3 tracks.",""
repetition,balanced,playful,2,"Has range. Unfortunately so do their mixed signals.",""
repetition,balanced,playful,3,"Healthy rotation. Slightly avoidant.",""
repetition,defaults_to_safety,playful,1,"Plays the same 3 songs like itâ€™s a coping mechanism.",""
repetition,defaults_to_safety,playful,2,"Emotionally available to exactly one chorus.",""
repetition,defaults_to_safety,playful,2,"Believes healing is just re-playing the bridge.",""
time_of_day,morning,playful,2,"A morning listener. Has their life togetherâ€¦ suspiciously.",""
time_of_day,day,playful,2,"Daytime listener. Keeps it functional. Keeps it distant.",""
time_of_day,night,playful,1,"Late-night listener. Texts â€˜you up?â€™ with a playlist link.",""
time_of_day,late_night,playful,1,"After-midnight listener. Falls in love with the idea of someone.",""
insight,any,playful,1,"Craves variety, defaults to safety.",""
insight,any,playful,1,"Public taste. Private feelings.",""
insight,any,playful,1,"Runs on routine. Avoids vulnerability.",""
insight,any,playful,1,"Processes emotions exclusively through headphones.",""
obscurity,mainstream,sharp,2,"Your taste is algorithm-approved and emotionally risk-averse.",""
obscurity,taste_curious,sharp,2,"You want credit for being interesting without doing the work.",""
obscurity,obscure,sharp,2,"You use obscurity to avoid being understood.",""
repetition,craves_variety,sharp,2,"You call it variety. Itâ€™s commitment issues.",""
repetition,balanced,sharp,2,"Youâ€™re stable. You still wonâ€™t text back.",""
repetition,defaults_to_safety,sharp,2,"You loop the same song because change scares you.",""
time_of_day,morning,sharp,2,"Morning music. Controlled personality. Unavailable heart.",""
time_of_day,day,sharp,2,"Daytime listening. You avoid feelings until the meeting ends.",""
time_of_day,night,sharp,2,"Night listener. Romantic until accountability shows up.",""
time_of_day,late_night,sharp,2,"After midnight you become a different person (worse).",""
insight,any,sharp,1,"Your vibe is chaos with a comfort blanket.",""
insight,any,sharp,1,"You want novelty, but only on your terms.",""
insight,any,sharp,1,"Youâ€™re emotionally consistentâ€¦ at avoiding intimacy.",""
`;

    /******************************************************************
     * 2) DOM
     ******************************************************************/
    const loginView = document.getElementById("loginView");
    const resultsView = document.getElementById("resultsView");
    const stampText = document.getElementById("stampText");

    const btnLogin = document.getElementById("btnLogin");
    const btnLogout = document.getElementById("btnLogout");
    const btnLogout2 = document.getElementById("btnLogout2");

    const openerText = document.getElementById("openerText");
    const flagsList = document.getElementById("flagsList");
    const insightLine = document.getElementById("insightLine");
    const btnRoastAgain = document.getElementById("btnRoastAgain");

    // Share kit
    const btnShareX = document.getElementById("btnShareX");
    const btnShareIG = document.getElementById("btnShareIG");
    const btnShareTT = document.getElementById("btnShareTT");
    const btnCopyCaption = document.getElementById("btnCopyCaption");
    const btnSaveImage = document.getElementById("btnSaveImage");
    const btnCopyLink = document.getElementById("btnCopyLink");
    const shareUrlEl = document.getElementById("shareUrl");
    const shareHint = document.getElementById("shareHint");
    const shareNote = document.getElementById("shareNote");
    const shareCard = document.getElementById("shareCard");
    let lastShareCaption = "";

    const toneSelect = document.getElementById("toneSelect");
    const toast = document.getElementById("toast");
    const toast2 = document.getElementById("toast2");
    const ruleEl = document.getElementById("rule");
    const insightBox = document.getElementById("insightBox");

    /******************************************************************
     * 3) CSV PARSER
     ******************************************************************/
    function splitCSVLine(line) {
      const out = [];
      let cur = "";
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (inQuotes && line[i+1] === '"') { cur += '"'; i++; }
          else inQuotes = !inQuotes;
        } else if (ch === ',' && !inQuotes) {
          out.push(cur);
          cur = "";
        } else {
          cur += ch;
        }
      }
      out.push(cur);
      return out;
    }

    function parseCSV(csvText) {
      const lines = csvText.split(/\r?\n/).filter(l => l.trim().length > 0);
      const header = splitCSVLine(lines[0]).map(h => h.trim());
      const rows = [];

      for (let i = 1; i < lines.length; i++) {
        const cols = splitCSVLine(lines[i]);
        const obj = {};
        header.forEach((h, idx) => obj[h] = (cols[idx] ?? "").trim());
        obj.priority = Number(obj.priority || 3);
        rows.push(obj);
      }
      return rows;
    }

    const jokesTable = parseCSV(JOKES_CSV);

    /******************************************************************
     * 4) SPOTIFY AUTH (PKCE)
     ******************************************************************/
    function base64urlencode(arrayBuffer) {
      const bytes = new Uint8Array(arrayBuffer);
      let str = "";
      for (const b of bytes) str += String.fromCharCode(b);
      return btoa(str).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
    }

    async function sha256(plain) {
      const encoder = new TextEncoder();
      const data = encoder.encode(plain);
      return await crypto.subtle.digest("SHA-256", data);
    }

    function randomString(length = 64) {
      const charset = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~";
      let result = "";
      const values = crypto.getRandomValues(new Uint8Array(length));
      for (let i = 0; i < values.length; i++) result += charset[values[i] % charset.length];
      return result;
    }

    async function loginSpotify() {
      if (!SPOTIFY_CLIENT_ID || SPOTIFY_CLIENT_ID.includes("PASTE_")) {
        showToast(toast, "Paste your Spotify Client ID in the code first.");
        return;
      }

      const verifier = randomString(64);
      const challenge = base64urlencode(await sha256(verifier));
      localStorage.setItem("pkce_verifier", verifier);

      const params = new URLSearchParams({
        client_id: SPOTIFY_CLIENT_ID,
        response_type: "code",
        redirect_uri: REDIRECT_URI,
        code_challenge_method: "S256",
        code_challenge: challenge,
        scope: SCOPES.join(" ")
      });

      window.location = "https://accounts.spotify.com/authorize?" + params.toString();
    }

    async function exchangeCodeForToken(code) {
      const verifier = localStorage.getItem("pkce_verifier");
      const body = new URLSearchParams({
        client_id: SPOTIFY_CLIENT_ID,
        grant_type: "authorization_code",
        code,
        redirect_uri: REDIRECT_URI,
        code_verifier: verifier
      });

      const res = await fetch("https://accounts.spotify.com/api/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data?.error_description || "Token exchange failed");
      storeToken(data.access_token, data.expires_in);
      window.history.replaceState({}, document.title, REDIRECT_URI);
      return data.access_token;
    }

    function storeToken(token, expiresIn) {
      const exp = Date.now() + (expiresIn * 1000);
      localStorage.setItem("access_token", token);
      localStorage.setItem("token_exp", String(exp));
    }

    function getStoredToken() {
      const token = localStorage.getItem("access_token");
      const exp = Number(localStorage.getItem("token_exp") || 0);
      if (!token) return null;
      if (Date.now() > exp) return null;
      return token;
    }

    function logout() {
      localStorage.removeItem("access_token");
      localStorage.removeItem("token_exp");
      localStorage.removeItem("pkce_verifier");
      lastBuckets = null;
      lastResult = null;
      lastEvidence = null;
      switchToLogin();
      showToast(toast, "Logged out.");
    }

    /******************************************************************
     * 5) SPOTIFY DATA + SIGNALS
     ******************************************************************/
    async function spotifyGET(token, url) {
      const res = await fetch(url, {
        headers: { Authorization: "Bearer " + token }
      });
      if (!res.ok) {
        const t = await res.text();
        throw new Error(`Spotify ${res.status}: ${t}`);
      }
      return await res.json();
    }

    function mean(arr){
      if (!arr.length) return 0;
      return arr.reduce((a,b)=>a+b,0)/arr.length;
    }

    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

    async function fetchProfileBuckets(token){
      // Recent plays
      const recent = await spotifyGET(token, "https://api.spotify.com/v1/me/player/recently-played?limit=50");
      const items = recent?.items || [];
      const plays = items.map(it => ({
        track: it.track,
        played_at: it.played_at,
        artist: it.track?.artists?.[0] || null
      })).filter(p => p.track && p.artist);

      const recentPlays = plays.length;

      // Repetition (track id counts)
      const trackCounts = new Map();
      for (const p of plays) {
        const id = p.track.id;
        trackCounts.set(id, (trackCounts.get(id) || 0) + 1);
      }
      let maxRepeat = 0;
      let topTrackId = null;
      for (const [id, c] of trackCounts.entries()) {
        if (c > maxRepeat){ maxRepeat = c; topTrackId = id; }
      }

      // Time of day
      const hourCounts = Array.from({length:24}, ()=>0);
      for (const p of plays){
        const h = new Date(p.played_at).getHours();
        hourCounts[h] += 1;
      }
      const peakHour = hourCounts.indexOf(Math.max(...hourCounts));

      // Obscurity = average popularity of top artists from top tracks
      const topTracks = await spotifyGET(token, "https://api.spotify.com/v1/me/top/tracks?time_range=short_term&limit=30");
      const top = topTracks?.items || [];
      const artistIds = Array.from(new Set(top.flatMap(t => (t.artists||[]).map(a=>a.id)).filter(Boolean))).slice(0, 50);
      let avgPopularity = 50;
      if (artistIds.length){
        const artists = await spotifyGET(token, "https://api.spotify.com/v1/artists?ids=" + artistIds.join(","));
        const pops = (artists?.artists || []).map(a => a.popularity).filter(n => typeof n === "number");
        avgPopularity = Math.round(mean(pops));
      }

      // Buckets (some may still be used in generateRoast)
      const buckets = {};

      // repetition bucket
      if (maxRepeat >= 6) buckets.repetition = "defaults_to_safety";
      else if (maxRepeat <= 2) buckets.repetition = "craves_variety";
      else buckets.repetition = "balanced";

      // time_of_day bucket
      let tod = "day";
      if (peakHour >= 5 && peakHour <= 10) tod = "morning";
      if (peakHour >= 19 && peakHour <= 23) tod = "night";
      if (peakHour >= 0 && peakHour <= 3) tod = "late_night";
      buckets.time_of_day = tod;

      // obscurity bucket
      if (avgPopularity >= 75) buckets.obscurity = "mainstream";
      else if (avgPopularity >= 45) buckets.obscurity = "taste_curious";
      else buckets.obscurity = "obscure";

      // Evidence receipts
      const evidence = {
        repetition: {
          maxRepeat,
          topTrack: plays.find(p => p.track.id === topTrackId)?.track || null
        },
        time_of_day: {
          peakHour,
          hourCounts
        },
        obscurity: {
          avgPopularity
        }
      };

      const debug = { recentPlays, maxRepeat, peakHour, avgPopularity };

      return { buckets, evidence, debug };
    }

    /******************************************************************
     * 6) ROAST GENERATION
     ******************************************************************/
    function pickRows(parameter, bucket, tone){
      const rows = jokesTable.filter(r =>
        r.parameter === parameter &&
        (r.bucket === bucket || r.bucket === "any") &&
        r.tone === tone
      );

      // weighted by priority (lower priority number = more likely)
      const sorted = rows.slice().sort((a,b)=>a.priority-b.priority);
      return sorted;
    }

    function randomPick(arr){
      if (!arr.length) return null;
      return arr[Math.floor(Math.random()*arr.length)];
    }

    function generateRoast(buckets, tone){
      const ordered = [];

      const params = ["obscurity","repetition","time_of_day"];
      for (const p of params){
        const bucket = buckets[p];
        const pick = randomPick(pickRows(p, bucket, tone));
        if (pick) ordered.push(pick);
      }

      // closer (insight bucket is 'any' â€“ will be improved later)
      const insightPick = randomPick(pickRows("insight", "any", tone));
      const insight = insightPick?.joke_text || "Your vibe is complicated.";

      // Ensure opener exists
      if (!ordered.length){
        ordered.push({ joke_text:"Data unavailable. Still suspicious." });
      }
      return { ordered, insight };
    }

    function escapeHTML(s){
      return (s||"").replace(/[&<>"']/g, (c)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[c]));
    }

    function showToast(el, msg){
      if (!el) return;
      el.textContent = msg;
      setTimeout(()=>{ if(el.textContent === msg) el.textContent = ""; }, 2600);
    }

    function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

    function clearResults(){
      openerText.innerHTML = `<span class="flag">ðŸš©</span>Loadingâ€¦`;
      flagsList.innerHTML = "";
      insightLine.textContent = "Loadingâ€¦";
      ruleEl.classList.add("hidden");
      flagsList.classList.add("hidden");
      insightBox.classList.add("hidden");
    }

    function buildBecauseLine(row, evidence){
      if (!row || !evidence) return "";
      const p = row.parameter;
      if (p === "repetition"){
        const max = evidence.repetition?.maxRepeat ?? 0;
        const t = evidence.repetition?.topTrack;
        if (!t) return max ? `because your #1 track was played ${max}Ã— recently.` : "";
        return `because your #1 track (â€œ${t.name}â€ by ${t.artists?.[0]?.name || "Unknown"} ) was played ${max}Ã— in your last 50 listens.`;
      }
      if (p === "time_of_day"){
        const h = evidence.time_of_day?.peakHour;
        if (typeof h !== "number") return "";
        const label =
          (h>=0 && h<=3) ? "after midnight" :
          (h>=5 && h<=10) ? "morning" :
          (h>=19 && h<=23) ? "night" : "day";
        return `because your listening peaks around ${h}:00 (${label}).`;
      }
      if (p === "obscurity"){
        const pop = evidence.obscurity?.avgPopularity;
        if (typeof pop !== "number") return "";
        return `because your average artist popularity is ${pop}/100.`;
      }
      return "";
    }

    let lastBuckets = null;
    let lastEvidence = null;
    let lastResult = null;

    async function renderRoastFromBuckets(buckets, evidence){
      clearResults();
      const tone = toneSelect.value;
      const { ordered, insight } = generateRoast(buckets, tone);
      lastResult = { ordered, insight, tone };
      lastBuckets = buckets;

      // opener alone
      const opener = ordered[0]?.joke_text || "Data unavailable. Still suspicious.";
      const openerRow = ordered[0] || null;
      const openerBecause = buildBecauseLine(openerRow, evidence);
      openerText.innerHTML =
        `<span class="flag">ðŸš©</span>${escapeHTML(opener)}${
          openerBecause ? `<div class="because">${escapeHTML(openerBecause)}</div>` : ""
        }`;
      await sleep(720);

      ruleEl.classList.remove("hidden");
      flagsList.classList.remove("hidden");

      const rest = ordered.slice(1);
      for (let i=0;i<rest.length;i++){
        const li = document.createElement("li");
        li.className = "fadeIn";

        const isLast = (i === rest.length - 1);
        if (isLast) {
          li.classList.add("role-close");
        } else {
          li.classList.add("role-core");
          if (i % 2 === 1) li.classList.add("alt");
        }

        const because = buildBecauseLine(rest[i], evidence);
        li.innerHTML =
          `<span class="flag">ðŸš©</span>${escapeHTML(rest[i].joke_text)}${
            because ? `<div class="because">${escapeHTML(because)}</div>` : ""
          }`;

        flagsList.appendChild(li);
        await sleep(220);
      }

      insightLine.textContent = insight;
      insightBox.classList.remove("hidden");
      insightBox.classList.add("fadeIn");
      updateShareKit();
    }

    function safeNowUrl(){
      // Strip OAuth params for cleaner sharing
      const u = new URL(window.location.href);
      u.searchParams.delete("code");
      u.searchParams.delete("state");
      u.searchParams.delete("error");
      u.searchParams.delete("error_description");
      return u.origin + u.pathname;
    }

    function buildShareCaption(){
      const url = safeNowUrl();
      const pattern = (insightLine?.textContent || "").trim();
      const openerMain = (lastResult?.ordered?.[0]?.joke_text || "").trim();

      const firstBecause =
        document.querySelector("#openerText .because")?.textContent?.trim() ||
        document.querySelector("#flagsList .because")?.textContent?.trim() ||
        "";

      const pieces = [];
      if (pattern) pieces.push(`Spotify just exposed my dating pattern: ${pattern} ðŸš©`);
      else pieces.push("Spotify Dating Red Flags ðŸš©");

      if (openerMain) pieces.push(openerMain);

      if (firstBecause){
        const cleaned = firstBecause.replace(/^because\s*/i,"");
        pieces.push(`receipts: ${cleaned}`);
      }

      pieces.push(`Run yours: ${url}`);
      return pieces.join("\n");
    }

    function buildXIntent(){
      const url = safeNowUrl();
      const pattern = (insightLine?.textContent || "").trim();

      const firstBecause =
        document.querySelector("#openerText .because")?.textContent?.trim() ||
        document.querySelector("#flagsList .because")?.textContent?.trim() ||
        "";

      let text = "Spotify Dating Red Flags ðŸš©";
      if (pattern) text = `My Spotify dating pattern: ${pattern} ðŸš©`;

      if (firstBecause){
        const cleaned = firstBecause.replace(/^because\s*/i,"");
        text += `\nreceipts: ${cleaned}`;
      }
      text += `\n${url}`;

      const intent = new URL("https://twitter.com/intent/tweet");
      intent.searchParams.set("text", text);
      return intent.toString();
    }

    function updateShareKit(){
      if (!shareUrlEl) return;
      const url = safeNowUrl();
      shareUrlEl.textContent = url;

      if (shareNote){
        shareNote.textContent = "Tip: post yours and tag 3 friends to compare results.";
      }

      lastShareCaption = buildShareCaption();

      if (btnShareX){
        btnShareX.href = buildXIntent();
      }

      if (shareHint){
        shareHint.textContent = "Generated from your Spotify listening history";
      }
    }

    async function copyText(textToCopy, okMsg){
      try{
        await navigator.clipboard.writeText(textToCopy);
        showToast(toast2, okMsg || "Copied.");
      }catch(e){
        window.prompt("Copy this:", textToCopy);
      }
    }

    async function saveShareImage(){
      if (!shareCard || typeof html2canvas !== "function"){
        showToast(toast2, "Share image unavailable.");
        return;
      }

      showToast(toast2, "Generating imageâ€¦");
      updateShareKit();

      const canvas = await html2canvas(shareCard, {
        backgroundColor: "#ffffff",
        scale: Math.min(2, window.devicePixelRatio || 1),
        useCORS: true
      });

      const dataUrl = canvas.toDataURL("image/png");
      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = "spotify-dating-red-flags.png";
      document.body.appendChild(a);
      a.click();
      a.remove();
      showToast(toast2, "Saved image. Post it and cause problems.");
    }

    function openInstagram(){
      // Can't prefill an IG post from a normal website. We copy caption and open IG.
      copyText(lastShareCaption, "Caption copied. Paste it in Instagram.");
      window.open("https://www.instagram.com/", "_blank", "noopener");
    }

    function openTikTok(){
      copyText(lastShareCaption, "Caption copied. Paste it in TikTok.");
      window.open("https://www.tiktok.com/upload", "_blank", "noopener");
    }

    /******************************************************************
     * 7) UI HELPERS
     ******************************************************************/
    function switchToLogin(){
      stampText.textContent = "WELCOME";
      loginView.classList.remove("hidden");
      resultsView.classList.add("hidden");
      btnLogout.classList.add("hidden");
    }

    function switchToResults(){
      stampText.textContent = "RESULTS";
      loginView.classList.add("hidden");
      resultsView.classList.remove("hidden");
    }

    /******************************************************************
     * 8) APP BOOT
     ******************************************************************/
    async function boot(){
      const url = new URL(window.location.href);
      const code = url.searchParams.get("code");

      let token = getStoredToken();

      if (code) {
        try{
          token = await exchangeCodeForToken(code);
        }catch(e){
          showToast(toast, "Login failed. Check redirect URI + Client ID.");
          switchToLogin();
          return;
        }
      }

      if (token) {
        try{
          btnLogout.classList.remove("hidden");
          switchToResults();
          const { buckets, evidence, debug } = await fetchProfileBuckets(token);
          lastEvidence = evidence;
          showToast(toast2, `Refetched ${new Date().toLocaleTimeString()} â€¢ maxRepeat=${debug.maxRepeat} â€¢ peakHour=${debug.peakHour}`);

          document.getElementById("resultsSubtitle").textContent =
            `Based on your listening habits. Recent plays scanned: ${debug.recentPlays}.`;
          await renderRoastFromBuckets(buckets, lastEvidence);

        }catch(e){
          console.error(e);
          showToast(toast, "Spotify error: " + (e?.message || "Unknown"));
          switchToLogin();
        }
      } else {
        switchToLogin();
      }
    }

    /******************************************************************
     * 9) EVENTS
     ******************************************************************/
    btnLogin.addEventListener("click", loginSpotify);
    btnLogout.addEventListener("click", logout);
    btnLogout2.addEventListener("click", logout);

    btnRoastAgain.addEventListener("click", async () => {
      const token = getStoredToken();
      if (!token) return;

      try {
        const { buckets, evidence, debug } = await fetchProfileBuckets(token);
        lastEvidence = evidence;
        showToast(toast2, `Refetched ${new Date().toLocaleTimeString()} â€¢ maxRepeat=${debug.maxRepeat} â€¢ peakHour=${debug.peakHour}`);
        document.getElementById("resultsSubtitle").textContent =
          `Based on your listening habits. Recent plays scanned: ${debug.recentPlays}.`;
        await renderRoastFromBuckets(buckets, lastEvidence);

      } catch (e) {
        console.error(e);
        showToast(toast2, "Spotify error: " + (e?.message || "Unknown"));
      }
    });

    // Share kit events
    btnCopyCaption?.addEventListener("click", () => copyText(lastShareCaption || buildShareCaption(), "Caption copied."));
    btnCopyLink?.addEventListener("click", () => copyText(safeNowUrl(), "Link copied."));
    btnSaveImage?.addEventListener("click", saveShareImage);
    btnShareIG?.addEventListener("click", openInstagram);
    btnShareTT?.addEventListener("click", openTikTok);

    toneSelect.addEventListener("change", () => lastBuckets && renderRoastFromBuckets(lastBuckets, lastEvidence));

    boot();
  </script>
</body>
</html>

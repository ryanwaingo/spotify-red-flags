<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spotify Dating Red Flags</title>
  <style>
    :root{
      --bg: #FFF7E6;
      --paper: #FFFFFF;
      --ink: #111111;
      --muted: #4D4D4D;

      --red: #E10600;
      --blue: #0057FF;
      --yellow: #FFE600;
      --green: #00C853;
      --pink: #FF3EB5;
      --purple: #7C4DFF;

      --b: 3px solid var(--ink);
      --pad: 22px;

      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      background: var(--bg);
      color: var(--ink);
      font-family: var(--sans);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }

    .wrap{
      min-height: 100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 28px 14px;
    }

    .frame{
      width: min(560px, 100%);
      border: var(--b);
      background: var(--paper);
      position: relative;
      padding: var(--pad);
      transform: translateX(-2px) translateY(1px);
    }

    .stamp{
      position:absolute;
      top:-16px;
      right:14px;
      border: var(--b);
      background: var(--pink);
      color: var(--ink);
      padding: 8px 10px;
      font-family: var(--mono);
      font-weight: 900;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 12px;
      transform: rotate(2deg);
      user-select:none;
    }

    .header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 14px;
    }

    .title{
      font-weight: 950;
      letter-spacing: -0.03em;
      line-height: 1.02;
      font-size: 24px;
      margin: 0;
    }

    .subtitle{
      margin-top: 8px;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
      line-height: 1.25;
    }

    .bar{
      height: 10px;
      border: var(--b);
      background: var(--yellow);
      margin: 10px 0 18px;
      transform: translateX(1px);
    }

    button{
      font-family: var(--mono);
      font-weight: 900;
      letter-spacing: 0.02em;
      padding: 12px 12px;
      border: var(--b);
      background: #fff;
      color: var(--ink);
      cursor:pointer;
    }
    button:active{ transform: translateY(1px); }

    .primary{
      background: var(--ink);
      color: #fff;
    }
    .primary:hover{
      background: var(--yellow);
      color: var(--ink);
    }

    .secondary:hover{
      background: var(--blue);
      color: #fff;
    }

    .note{
      border: var(--b);
      background: var(--yellow);
      padding: 10px 12px;
      font-family: var(--mono);
      font-size: 12px;
      margin-top: 12px;
    }

    .toast{
      margin-top: 10px;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--ink);
      border: var(--b);
      padding: 8px 10px;
      background: var(--yellow);
      display:none;
    }

    .hidden{ display:none !important; }

    .fadeIn{
      animation: fadeIn 180ms ease-out both;
    }
    @keyframes fadeIn{
      from{ opacity:0; transform: translateY(6px); }
      to{ opacity:1; transform: translateY(0); }
    }

    /* RESULTS UI */
    .openerPanel{
      border: var(--b);
      background: var(--blue);
      color: #fff;
      padding: 16px 14px;
      position: relative;
      transform: translateX(-1px);
      overflow:hidden;
    }
    .openerPanel::before{
      content:"";
      position:absolute;
      left:-10px;
      top:-10px;
      width:18px;
      height:18px;
      border: var(--b);
      background: var(--yellow);
    }
    .opener{
      font-weight: 950;
      letter-spacing: -0.05em;
      line-height: 1.05;
      font-size: 38px;
      margin: 0;
    }
    .flag{
      margin-right: 10px;
      color: var(--yellow);
    }

    .rule{
      height:0;
      border:none;
      border-top: var(--b);
      margin: 16px 0;
    }

    .list{
      margin:0;
      padding:0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .list li{
      border: var(--b);
      padding: 10px 10px;
      font-size: 18px;
      line-height: 1.22;
      letter-spacing: -0.01em;
      background: #fff;
      transform: translateX(1px);
    }
    .list li:nth-child(2n){ transform: translateX(-1px); }

    .list li:nth-child(1){ background: var(--yellow); }
    .list li:nth-child(2){ background: var(--green); color: var(--ink); }
    .list li:nth-child(3){ background: var(--paper); }
    .list li:nth-child(4){ background: var(--purple); color: #fff; }
    .list li:nth-child(5){ background: var(--pink); color: var(--ink); }
    .list li:nth-child(6){ background: var(--yellow); }
    .list li:nth-child(7){ background: var(--green); color: var(--ink); }

    /* Role-based colors (override nth-child chaos) */
.list li.role-core { background: var(--yellow) !important; color: var(--ink) !important; }
.list li.role-core.alt { background: var(--green) !important; color: var(--ink) !important; }
.list li.role-close { background: var(--pink) !important; color: var(--ink) !important; }


    .list .flag{ color: var(--red); }
    .list li:nth-child(4) .flag{ color: var(--yellow); }

    .insight{
      margin-top: 16px;
      border: var(--b);
      background: var(--yellow);
      padding: 14px;
      position: relative;
      transform: translateX(1px);
    }
    .insight::after{
      content:"";
      position:absolute;
      right:-10px;
      bottom:-10px;
      width:18px;
      height:18px;
      border: var(--b);
      background: var(--red);
    }
    .insight .label{
      font-family: var(--mono);
      font-size: 12px;
      font-weight: 900;
      letter-spacing: 0.10em;
      text-transform: uppercase;
      color: var(--ink);
      margin-bottom: 10px;
    }
    .insight .line{
      font-size: 20px;
      font-weight: 900;
      letter-spacing: -0.02em;
      line-height: 1.15;
    }

    .actions{
      margin-top: 16px;
      border: var(--b);
      background: #fff;
      padding: 12px;
      display:grid;
      gap: 10px;
      transform: translateX(-1px);
    }

    .toneRow{
      border: var(--b);
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background: var(--green);
    }
    .toneRow .label{
      font-family: var(--mono);
      font-weight: 900;
      font-size: 12px;
      letter-spacing: 0.10em;
      text-transform: uppercase;
      color: var(--ink);
      white-space:nowrap;
    }
    select{
      font-family: var(--mono);
      font-weight: 900;
      border: var(--b);
      background: #fff;
      color: var(--ink);
      padding: 8px 10px;
      cursor:pointer;
    }

    .micro{
      margin-top: 12px;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--ink);
      display:flex;
      justify-content:space-between;
      gap: 10px;
      border-top: var(--b);
      padding-top: 12px;
      align-items:flex-start;
    }
    .micro .right{
      font-weight: 900;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 11px;
      background: var(--pink);
      border: var(--b);
      padding: 6px 8px;
      transform: rotate(-1deg);
      user-select:none;
    }

    @media (max-width:420px){
      .frame{ padding:18px; }
      .opener{ font-size: 32px; }
      .list li{ font-size: 17px; }
    }
  </style>
</head>

<body>
  <main class="wrap">
    <section class="frame">
      <div class="stamp" id="stampText">WELCOME</div>

      <!-- LOGIN VIEW -->
      <div id="loginView">
        <header class="header">
          <div>
            <h1 class="title">Spotify Dating Red Flags üö©</h1>
            <div class="subtitle">Log in, get roasted, screenshot, repeat.</div>
          </div>
          <button id="btnLogout" class="secondary hidden" type="button">Log out</button>
        </header>

        <div class="bar" aria-hidden="true"></div>

        <button id="btnLogin" class="primary" type="button">Continue with Spotify</button>

        <div class="note">
          We only read your listening data. We don‚Äôt post. We don‚Äôt save your password.
        </div>

        <div id="toast" class="toast" role="status" aria-live="polite"></div>
      </div>

      <!-- RESULTS VIEW -->
      <div id="resultsView" class="hidden" aria-label="Results">
        <header class="header">
          <div>
            <h1 class="title">Your Spotify Dating Red Flags üö©</h1>
            <div class="subtitle" id="resultsSubtitle">Based on your listening habits. Not serious. Very specific.</div>
          </div>
          <button id="btnLogout2" class="secondary" type="button">Log out</button>
        </header>

        <div class="bar" aria-hidden="true"></div>

        <div id="openerPanel" class="openerPanel">
          <div id="openerText" class="opener"><span class="flag">üö©</span>Loading‚Ä¶</div>
        </div>

        <hr id="rule" class="rule" />

        <ul id="flagsList" class="list" aria-label="Red flags"></ul>

        <div id="insightBox" class="insight" role="note" aria-label="Biggest dating pattern">
          <div class="label">Biggest Dating Pattern This Year</div>
          <div id="insightLine" class="line">Loading‚Ä¶</div>
        </div>

        <div class="actions">
          <button id="btnRoastAgain" class="primary" type="button">Roast Again</button>
          <button id="btnShare" class="secondary" type="button">Share This</button>

          <div class="toneRow" aria-label="Tone selector">
            <div class="label">Tone</div>
            <select id="toneSelect">
              <option value="playful" selected>Playful</option>
              <option value="sharp">Sharp</option>
            </select>
          </div>

          <div id="toast2" class="toast" role="status" aria-live="polite"></div>
        </div>

        <div class="micro">
          <div class="left">If you‚Äôre mad, take it up with your playlists.</div>
          <div class="right">üö© VERIFIED</div>
        </div>
      </div>
    </section>
  </main>

  <script>
    /***********************
     * 0) YOU MUST SET THIS
     ***********************/
    const SPOTIFY_CLIENT_ID = "ad08cfcd496348e299ba9a840227954d";
const REDIRECT_URI = window.location.origin + window.location.pathname; // GitHub Pages URL
const SCOPES = [
  "user-top-read",
  "user-read-recently-played"
];


    /******************************************************************
     * 1) YOUR JOKES CSV (already formatted for the parser)
     ******************************************************************/
    const JOKES_CSV = `parameter,bucket,tone,priority,joke_text,notes
obscurity,mainstream,playful,2,"Says ‚ÄòI just like good music‚Äô and lets Spotify handle the rest.",""
obscurity,mainstream,playful,2,"Claims they don‚Äôt follow trends. Quietly follows all of them.",""
obscurity,mainstream,playful,3,"Comfortable taste. Low emotional risk.",""
obscurity,mainstream,playful,3,"Prefers familiarity over surprise.",""
obscurity,mainstream,playful,3,"Trusts charts more than instincts.",""
obscurity,mainstream,playful,3,"Lets popularity do the filtering.",""
obscurity,mainstream,playful,3,"Avoids musical friction.",""
obscurity,mainstream,playful,3,"Believes good taste should be easy.",""
obscurity,taste_curious,playful,2,"Likes popular music but wants credit for finding it early.",""
obscurity,taste_curious,playful,2,"Balances discovery with vibes. Hates being called predictable.",""
obscurity,taste_curious,playful,3,"Dabbles in niche. Retreats to hits.",""
obscurity,taste_curious,playful,3,"Explores just enough to feel interesting.",""
obscurity,taste_curious,playful,3,"Samples the underground. Lives upstairs.",""
obscurity,taste_curious,playful,3,"Wants novelty with a safety net.",""
obscurity,taste_curious,playful,3,"Curates discovery carefully.",""
obscurity,taste_curious,playful,3,"Enjoys being adjacent to obscure.",""
obscurity,deep_cut,sharp,1,"Gatekeeps artists they found by accident.","strong"
obscurity,deep_cut,playful,2,"Mentions obscurity unprompted.",""
obscurity,deep_cut,playful,2,"Treats low listener counts like credentials.",""
obscurity,deep_cut,playful,3,"Has said ‚Äòyou probably haven‚Äôt heard of them‚Äô at least once.",""
obscurity,deep_cut,playful,3,"Feels rewarded for digging.",""
obscurity,deep_cut,playful,3,"Measures taste in scarcity.",""
obscurity,deep_cut,playful,3,"Suspicious of anything popular.",""
obscurity,deep_cut,playful,3,"Finds identity in discovery.",""
genre_breadth,single_lane,playful,1,"Knows what they like. Will not try your restaurant.",""
genre_breadth,single_lane,playful,2,"Consistency over curiosity.",""
genre_breadth,single_lane,playful,2,"Emotionally monogamous‚Ä¶ musically.",""
genre_breadth,single_lane,playful,3,"Prefers depth over range.",""
genre_breadth,single_lane,playful,3,"Builds routines around familiarity.",""
genre_breadth,single_lane,playful,3,"Stays in their lane comfortably.",""
genre_breadth,single_lane,playful,3,"Avoids genre whiplash.",""
genre_breadth,single_lane,playful,3,"Commits early and sticks.",""
genre_breadth,selective_explorer,playful,2,"Open-minded within carefully controlled limits.",""
genre_breadth,selective_explorer,playful,2,"Tries new things once. Returns to comfort.",""
genre_breadth,selective_explorer,playful,3,"Adventurous on weekends only.",""
genre_breadth,selective_explorer,playful,3,"Explores with guardrails.",""
genre_breadth,selective_explorer,playful,3,"Samples widely, settles narrowly.",""
genre_breadth,selective_explorer,playful,3,"Balances novelty with stability.",""
genre_breadth,selective_explorer,playful,3,"Keeps taste curated.",""
genre_breadth,omnivore,playful,1,"Open to everything. Commits to nothing.",""
genre_breadth,omnivore,playful,2,"Eclectic taste, indecisive energy.",""
genre_breadth,omnivore,playful,2,"Collects genres like options.",""
genre_breadth,omnivore,playful,3,"Variety-first mindset.",""
genre_breadth,omnivore,playful,3,"Refuses to be boxed in.",""
genre_breadth,omnivore,playful,3,"Enjoys contrast more than cohesion.",""
genre_breadth,omnivore,playful,3,"Thrives on switching vibes.",""
genre_breadth,omnivore,playful,3,"Says ‚Äòit depends‚Äô a lot.",""
repetition,stuck,sharp,1,"Has not emotionally moved on from something.","opener"
time_of_day,late_night,playful,1,"Processes feelings when no one can respond.",""
valence,sad_banger,playful,1,"Feels deeply. Avoids confrontation.",""
energy,high,sharp,1,"Fun. Exhausting.",""
exploration,comfort_first,playful,2,"Stays where it‚Äôs safe.",""
playlist_naming,emotional,playful,1,"Names feelings instead of discussing them.",""
popularity_contradiction,contradiction,sharp,1,"Gatekeeps music. Dates broadly.",""
main_character,full_montage,playful,1,"Lives like a montage.","headline"
combo,sad_late_repeat,playful,1,"Processes feelings privately and repeatedly.","combo"
combo,deepcut_main_character,sharp,1,"Wants attention without being mainstream.","combo"
combo,high_energy_comfort,playful,1,"Intense but emotionally routine.","combo"
combo,omnivore_novelty,playful,1,"Loves options. Hates decisions.","combo"
combo,mainstream_emotional,playful,1,"Feels deeply but keeps it accessible.","combo"`;


    /******************************************************************
     * 2) DOM
     ******************************************************************/
    const loginView = document.getElementById("loginView");
    const resultsView = document.getElementById("resultsView");
    const btnLogin = document.getElementById("btnLogin");
    const btnLogout = document.getElementById("btnLogout");
    const btnLogout2 = document.getElementById("btnLogout2");
    const stampText = document.getElementById("stampText");

    const openerText = document.getElementById("openerText");
    const flagsList = document.getElementById("flagsList");
    const insightLine = document.getElementById("insightLine");
    const btnRoastAgain = document.getElementById("btnRoastAgain");
    const btnShare = document.getElementById("btnShare");
    const toneSelect = document.getElementById("toneSelect");
    const toast = document.getElementById("toast");
    const toast2 = document.getElementById("toast2");
    const ruleEl = document.getElementById("rule");
    const insightBox = document.getElementById("insightBox");

    /******************************************************************
     * 3) CSV PARSER
     ******************************************************************/
    function splitCSVLine(line) {
      const out = [];
      let cur = "";
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (inQuotes && line[i+1] === '"') { cur += '"'; i++; }
          else inQuotes = !inQuotes;
        } else if (ch === ',' && !inQuotes) {
          out.push(cur);
          cur = "";
        } else {
          cur += ch;
        }
      }
      out.push(cur);
      return out;
    }

    function parseCSV(csvText) {
      const lines = csvText.split(/\r?\n/).filter(l => l.trim().length > 0);
      const header = splitCSVLine(lines[0]).map(h => h.trim());
      const rows = [];

      for (let i = 1; i < lines.length; i++) {
        const cols = splitCSVLine(lines[i]);
        const obj = {};
        header.forEach((h, idx) => obj[h] = (cols[idx] ?? "").trim());
        obj.priority = Number(obj.priority || 3);
        rows.push(obj);
      }
      return rows;
    }

    const jokesTable = parseCSV(JOKES_CSV);

    /******************************************************************
     * 4) SPOTIFY AUTH (PKCE)
     ******************************************************************/
    function base64urlencode(arrayBuffer) {
      const bytes = new Uint8Array(arrayBuffer);
      let str = "";
      for (const b of bytes) str += String.fromCharCode(b);
      return btoa(str).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
    }

    async function sha256(plain) {
      const encoder = new TextEncoder();
      const data = encoder.encode(plain);
      return await crypto.subtle.digest("SHA-256", data);
    }

    function randomString(length = 64) {
      const charset = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~";
      let result = "";
      const values = crypto.getRandomValues(new Uint8Array(length));
      for (let i = 0; i < values.length; i++) result += charset[values[i] % charset.length];
      return result;
    }

    async function loginSpotify() {
      if (!SPOTIFY_CLIENT_ID || SPOTIFY_CLIENT_ID.includes("PASTE_")) {
        showToast(toast, "Paste your Spotify Client ID in the code first.");
        return;
      }

      const verifier = randomString(64);
      const challenge = base64urlencode(await sha256(verifier));
      localStorage.setItem("pkce_verifier", verifier);

      const params = new URLSearchParams({
        client_id: SPOTIFY_CLIENT_ID,
        response_type: "code",
        redirect_uri: REDIRECT_URI,
        code_challenge_method: "S256",
        code_challenge: challenge,
        scope: SCOPES.join(" ")
      });

      window.location = "https://accounts.spotify.com/authorize?" + params.toString();
    }

    async function exchangeCodeForToken(code) {
      const verifier = localStorage.getItem("pkce_verifier");
      if (!verifier) throw new Error("Missing PKCE verifier.");

      const body = new URLSearchParams({
        client_id: SPOTIFY_CLIENT_ID,
        grant_type: "authorization_code",
        code,
        redirect_uri: REDIRECT_URI,
        code_verifier: verifier
      });

      const res = await fetch("https://accounts.spotify.com/api/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
      });

      if (!res.ok) throw new Error("Token exchange failed.");
      const data = await res.json();
      localStorage.setItem("spotify_access_token", data.access_token);
      localStorage.setItem("spotify_token_expires_at", String(Date.now() + (data.expires_in * 1000)));
      // cleanup URL
      const url = new URL(window.location.href);
      url.searchParams.delete("code");
      url.searchParams.delete("state");
      window.history.replaceState({}, document.title, url.toString());
      return data.access_token;
    }

    function getStoredToken() {
      const token = localStorage.getItem("spotify_access_token");
      const expiresAt = Number(localStorage.getItem("spotify_token_expires_at") || "0");
      if (!token) return null;
      if (Date.now() > expiresAt) return null;
      return token;
    }

    function logout() {
      localStorage.removeItem("spotify_access_token");
      localStorage.removeItem("spotify_token_expires_at");
      localStorage.removeItem("pkce_verifier");
      switchToLogin();
    }

    /******************************************************************
     * 5) SPOTIFY API CALLS (V1 minimal)
     ******************************************************************/
    async function spotifyGet(token, path) {
  const url = "https://api.spotify.com/v1" + path;
  const res = await fetch(url, {
    headers: { Authorization: "Bearer " + token }
  });

  const bodyText = await res.text().catch(() => "");
  if (!res.ok) {
    throw new Error(`Spotify API ${res.status} on ${path}: ${bodyText}`);
  }

  try { return JSON.parse(bodyText); }
  catch { return {}; }
}


    async function fetchProfileBuckets(token) {
   
  // 1) Recently played (behavior-based signals)
  const recent = await spotifyGet(token, "/me/player/recently-played?limit=50");
  const items = recent.items || [];

  const trackCounts = new Map();
  const hourCounts = new Array(24).fill(0);

  for (const it of items) {
    const t = it.track;
    if (!t || !t.id) continue;

    trackCounts.set(t.id, (trackCounts.get(t.id) || 0) + 1);

    const playedAt = new Date(it.played_at);
    const hr = playedAt.getHours();
    if (!Number.isNaN(hr)) hourCounts[hr]++;
  }

  // Time-of-day bucket (mapped to what your jokes support)
  const peakHour = hourCounts.reduce((best, v, i) => v > hourCounts[best] ? i : best, 0);
  const time_of_day = "late_night"; // keep stable until you add more joke buckets

  // Repetition bucket
  const counts = Array.from(trackCounts.values());
  const maxRepeat = counts.length ? Math.max(...counts) : 1;
  let repetition = "situational_repeater";
  if (maxRepeat >= 4) repetition = "stuck";
  else if (maxRepeat >= 2) repetition = "comfort_looper";

  // 2) Top tracks ‚Üí artist popularity ‚Üí obscurity
  const top = await spotifyGet(token, "/me/top/tracks?time_range=medium_term&limit=25");
  const tracks = top.items || [];

  const artistIds = [];
  for (const tr of tracks) {
    for (const a of (tr.artists || [])) {
      if (a && a.id) artistIds.push(a.id);
    }
  }

  const uniqueArtistIds = Array.from(new Set(artistIds)).slice(0, 50);
  let obscurity = "taste_curious";

  if (uniqueArtistIds.length) {
    const artists = await spotifyGet(token, "/artists?ids=" + uniqueArtistIds.join(","));
    const pops = (artists.artists || [])
      .map(a => a?.popularity)
      .filter(v => typeof v === "number");

    const avgPop = pops.length ? pops.reduce((a,b)=>a+b,0) / pops.length : 50;

    if (avgPop >= 65) obscurity = "mainstream";
    else if (avgPop >= 40) obscurity = "taste_curious";
    else obscurity = "deep_cut";
  }

  // Buckets you already have jokes for
  const buckets = {
    repetition,
    time_of_day,
    obscurity,

    valence: "sad_banger",
    energy: "high",
    exploration: "comfort_first",
    playlist_naming: "emotional",
    popularity_contradiction: "contradiction",
    main_character: "full_montage",
    genre_breadth: "omnivore"
  };

  return {
    buckets,
    debug: {
      recentPlays: items.length,
      maxRepeat,
      peakHour,
      obscurity
    }
  };
}


    /******************************************************************
     * 6) ROAST ENGINE (same as before, trimmed)
     ******************************************************************/
    const PARAMETER_RANK = [
      "repetition","obscurity","popularity_contradiction","playlist_naming",
      "time_of_day","valence","energy","exploration","genre_breadth","main_character"
    ];

    function randomChoice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function removeFirstMatch(arr, pred){
      for(let i=0;i<arr.length;i++){ if(pred(arr[i])) return arr.splice(i,1)[0]; }
      return null;
    }
    function shuffleInPlace(arr){
      for (let i=arr.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
    }

    function generateRoast(userBuckets, selectedTone) {
  const MAX_FLAGS = 5;
  const MIN_FLAGS = 5;

  // Tone filter
  let eligible = jokesTable.slice();
  if (selectedTone === "playful") eligible = eligible.filter(r => r.tone === "playful");
  if (selectedTone === "sharp") eligible = eligible.filter(r => (r.tone === "sharp" || r.tone === "playful"));

  const used = new Set();

  const pickOne = (parameter, bucket, priority) => {
    if (!parameter || !bucket) return null;
    const pool = eligible
      .filter(r => r.parameter === parameter)
      .filter(r => r.bucket === bucket)
      .filter(r => Number(r.priority) === Number(priority))
      .filter(r => !used.has(r.joke_text));

    if (!pool.length) return null;
    const chosen = randomChoice(pool);
    used.add(chosen.joke_text);
    return chosen;
  };

  const pickAnyPriority = (parameter, bucket, priorities) => {
    for (const p of priorities) {
      const hit = pickOne(parameter, bucket, p);
      if (hit) return hit;
    }
    return null;
  };

  const picks = [];

  // 1) Opener: force priority 1 if possible, else fall back to 2, else 3
  // Use the ranked parameters so opener feels "on-theme"
  let opener = null;
  for (const param of PARAMETER_RANK) {
    const bucket = userBuckets[param];
    opener = pickAnyPriority(param, bucket, [1, 2, 3]);
    if (opener) break;
  }
  if (opener) picks.push(opener);

  // 2) Core: prioritize priority-2 jokes across remaining params
  const core = [];
  for (const param of PARAMETER_RANK) {
    if (core.length >= 3) break;
    const bucket = userBuckets[param];
    const hit = pickOne(param, bucket, 2);
    if (hit) core.push(hit);
  }
  // If not enough, allow priority-1 (but avoid duplicating opener) then priority-3
  for (const param of PARAMETER_RANK) {
    if (core.length >= 3) break;
    const bucket = userBuckets[param];
    const hit = pickAnyPriority(param, bucket, [1, 3]);
    if (hit) core.push(hit);
  }
  shuffleInPlace(core);
  picks.push(...core);

  // 3) Texture: add 1‚Äì2 priority-3 jokes (or whatever‚Äôs left) to reach MIN_FLAGS
  const texture = [];
  for (const param of PARAMETER_RANK) {
    if (picks.length + texture.length >= MAX_FLAGS) break;
    const bucket = userBuckets[param];
    const hit = pickAnyPriority(param, bucket, [3, 2, 1]);
    if (hit) texture.push(hit);
    if (picks.length + texture.length >= MIN_FLAGS && texture.length >= 1) break;
  }
  picks.push(...texture);

  // 4) Optional combo: max one, only if we have space
  // (We don‚Äôt ‚Äúcompute‚Äù combos yet ‚Äî we just use them sparingly as spice.)
  if (picks.length < MAX_FLAGS) {
    const comboPool = eligible
      .filter(r => r.parameter === "combo")
      .filter(r => !used.has(r.joke_text));

    if (comboPool.length && Math.random() < 0.35) {
      const combo = randomChoice(comboPool);
      used.add(combo.joke_text);
      picks.push(combo);
    }
  }

  // Cap + ensure minimum
  const ordered = picks.slice(0, MAX_FLAGS);

  // Track which parameters actually contributed jokes
  const contributingParams = new Set(
    ordered.map(j => j.parameter).filter(Boolean)
  );

  // Insight line: derived from buckets, but only if supported by shown flags
  const insight = insightFromBuckets(userBuckets, contributingParams);


  return { ordered, insight };
}


    /******************************************************************
     * 7) RENDER + PACING
     ******************************************************************/
    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }
    function escapeHTML(str){
      return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function clearResults(){
      flagsList.innerHTML = "";
      ruleEl.classList.add("hidden");
      flagsList.classList.add("hidden");
      insightBox.classList.add("hidden");
      toast2.style.display="none";
      toast2.textContent="";
    }

    let lastResult = null;
    let lastBuckets = null;

    function insightFromBuckets(b, usedParams = new Set()) {

  // Combo patterns (feel ‚Äúsmart‚Äù)
  if (
  usedParams.has("repetition") &&
  usedParams.has("time_of_day") &&
  b.repetition === "stuck" &&
  b.time_of_day === "late_night"
) {
  return "Late-night loop pattern: processing privately, repeatedly.";
}

  if (b.obscurity === "deep_cut" && b.main_character === "full_montage") {
    return "Wants attention‚Ä¶ but only from the right audience.";
  }
  if (b.genre_breadth === "omnivore" && b.exploration === "comfort_first") {
    return "Craves variety, defaults to safety.";
  }

  // Single patterns (still not copies of jokes)
  if (b.repetition === "stuck") return "Unfinished business pattern: still in replay mode.";
  if (b.repetition === "comfort_looper") return "Comfort pattern: repeats feelings to stay regulated.";
  if (b.obscurity === "mainstream") return "Low-risk taste pattern: familiar, accessible, predictable.";
  if (b.obscurity === "deep_cut") return "Identity pattern: discovery is the personality.";
  if (b.time_of_day === "late_night") return "Late-night processor pattern: emotions after 10pm.";
  if (b.exploration === "comfort_first") return "Safety-net pattern: growth is optional, comfort is mandatory.";

  return "Pattern detected: selective vulnerability with high playlist literacy.";
}



    function reframeInsight(lastJoke) {
  const map = new Map([
    ["Feels deeply. Avoids confrontation.", "Emotional depth without emotional friction."],
    ["Processes feelings when no one can respond.", "Your emotional processing happens when the group chat is asleep."],
    ["Open to everything. Commits to nothing.", "You collect options like commitment is a malware popup."],
    ["Lives like a montage.", "You treat real life like it‚Äôs being edited by a hype intern."],
    ["Stays where it‚Äôs safe.", "Comfort-first‚Ä¶ even when it‚Äôs holding you back."],
    ["Names feelings instead of discussing them.", "You label emotions like files instead of opening them."]
  ]);

  return map.get(lastJoke) || (lastJoke ? `Pattern: ${lastJoke}` : "Pattern: unclear, still suspicious.");
}


    async function renderRoastFromBuckets(buckets){
      clearResults();
      const tone = toneSelect.value;
      const { ordered, insight } = generateRoast(buckets, tone);
      lastResult = { ordered, insight, tone };
      lastBuckets = buckets;

      // opener alone
      const opener = ordered[0]?.joke_text || "Data unavailable. Still suspicious.";
      openerText.innerHTML = `<span class="flag">üö©</span>${escapeHTML(opener)}`;
      await sleep(720);

      ruleEl.classList.remove("hidden");
      flagsList.classList.remove("hidden");

      const rest = ordered.slice(1);
for (let i=0;i<rest.length;i++){
  const li = document.createElement("li");
  li.className = "fadeIn";

  // Roles: core items alternate yellow/green, last one is the closer (pink)
  const isLast = (i === rest.length - 1);
  if (isLast) {
    li.classList.add("role-close");
  } else {
    li.classList.add("role-core");
    if (i % 2 === 1) li.classList.add("alt");
  }

  li.innerHTML = `<span class="flag">üö©</span>${escapeHTML(rest[i].joke_text)}`;
  flagsList.appendChild(li);
  await sleep(220);
}

      insightLine.textContent = insight;
      insightBox.classList.remove("hidden");
      insightBox.classList.add("fadeIn");
    }

    async function shareRoast(){
      if (!lastResult) return;
      const lines = lastResult.ordered.map(r => `üö© ${r.joke_text}`);
      const shareText =
`Spotify Dating Red Flags üö©
Tone: ${lastResult.tone}

${lines.join("\n")}

(Not serious. Very specific.)`;

      try{
        await navigator.clipboard.writeText(shareText);
        showToast(toast2, "Copied to clipboard.");
      }catch(e){
        window.prompt("Copy this:", shareText);
      }
    }

    function showToast(el, msg){
      el.textContent = msg;
      el.style.display="block";
      el.classList.remove("fadeIn");
      void el.offsetWidth;
      el.classList.add("fadeIn");
    }

    function switchToLogin(){
      stampText.textContent = "WELCOME";
      loginView.classList.remove("hidden");
      resultsView.classList.add("hidden");
      btnLogout.classList.add("hidden");
    }

    function switchToResults(){
      stampText.textContent = "RESULTS";
      loginView.classList.add("hidden");
      resultsView.classList.remove("hidden");
    }

    /******************************************************************
     * 8) APP BOOT
     ******************************************************************/
    async function boot(){
      // 1) If URL has "code", exchange it
      const url = new URL(window.location.href);
      const code = url.searchParams.get("code");

      let token = getStoredToken();

      if (code) {
        try{
          token = await exchangeCodeForToken(code);
        }catch(e){
          showToast(toast, "Login failed. Check redirect URI + Client ID.");
          switchToLogin();
          return;
        }
      }

      // 2) If token exists, fetch buckets + show results
      if (token) {
        try{
          btnLogout.classList.remove("hidden");
          switchToResults();
          const { buckets, debug } = await fetchProfileBuckets(token);
          document.getElementById("resultsSubtitle").textContent =
            `Based on your listening habits. Recent plays scanned: ${debug.recentPlays}.`;
          await renderRoastFromBuckets(buckets);
        }catch(e){
          console.error(e);
          showToast(toast, "Spotify error: " + (e?.message || "Unknown"));
          switchToLogin();
        }
      } else {
        switchToLogin();
      }
    }

    /******************************************************************
     * 9) EVENTS
     ******************************************************************/
    btnLogin.addEventListener("click", loginSpotify);
    btnLogout.addEventListener("click", logout);
    btnLogout2.addEventListener("click", logout);
    btnRoastAgain.addEventListener("click", () => lastBuckets && renderRoastFromBuckets(lastBuckets));
    btnShare.addEventListener("click", shareRoast);
    toneSelect.addEventListener("change", () => lastBuckets && renderRoastFromBuckets(lastBuckets));

    boot();
  </script>
</body>
</html>
